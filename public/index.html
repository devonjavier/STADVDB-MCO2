<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Details</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>Game Details</h1>

    <h2>Games Report</h2>
    <form id="reportForm">
        <label for="releaseYear">Release Year:</label>
        <input type="number" id="releaseYear" name="releaseYear" required><br><br>

        <label for="reportType">Report Type:</label>
        <select id="reportType" name="reportType" required>
            <option value="sum">Sum</option>
            <option value="avg">Average</option>
        </select><br><br>

        <button type="submit">Get Report</button>
    </form>

    <h3>Report Result:</h3>
    <p id="reportResult"></p>

    <!-- Form to Fetch Game Details -->
    <form id="gameForm">
        <h2>Select Game</h2>
        <label for="gameID">Game ID:</label>
        <input type="number" id="gameID" name="game_ID" required><br><br>
        <button type="submit">Get Game Details</button>
    </form>

    <!-- Table to Display Game Details -->
    <h2>Game Details</h2>
    <table id="gameDetailsTable" style="display:none;">
        <thead>
            <tr>
                <th>Game ID</th>
                <th>Game Name</th>
                <th>Release Date</th>
                <th>Game Description</th>
                <th>Price</th>
                <th>Estimated Ownership</th>
                <th>ESRB Rating</th>
            </tr>
        </thead>
        <tbody id="gameDetailsBody"></tbody>
    </table>

    <!-- Update Game Section -->
    <h2>Update Game</h2>
    <form id="updateForm">
        <label for="newGameName">New Game Name:</label>
        <input type="text" id="newGameName" name="game_name"><br><br>

        <label for="newReleaseDate">New Release Date:</label>
        <input type="date" id="newReleaseDate" name="release_date"><br><br>

        <label for="newDescription">New Description:</label>
        <textarea id="newDescription" name="game_description"></textarea><br><br>

        <label for="newPrice">New Price:</label>
        <input type="number" id="newPrice" name="price" step="0.01"><br><br>

        <label for="newOwnership">New Estimated Ownership:</label>
        <select id="newOwnership" name="estimated_ownership">
            <option value="">Select...</option>
            <option value="Very Low">Very Low</option>
            <option value="None">None</option>
            <option value="Low">Low</option>
            <option value="Low Moderate">Low Moderate</option>
            <option value="Moderate">Moderate</option>
            <option value="High Moderate">High Moderate</option>
            <option value="2M+">2M+</option>
            <option value="High">High</option>
        </select><br><br>

        <label for="newEsrbRating">New ESRB Rating:</label>
        <select id="newEsrbRating" name="esrb_rating">
            <option value="">Select...</option>
            <option value="E">E</option>
            <option value="M">M</option>
            <option value="AO">AO</option>
            <option value="T">T</option>
            <option value="E10">E10</option>
        </select><br><br>

        <button type="submit">Update Game</button>
    </form>

    <!-- Delete Game Section -->
    <h2>Delete Game</h2>
    <button id="deleteButton">Delete Game</button>

    <script>
        const form = document.getElementById('gameForm');
        const updateForm = document.getElementById('updateForm');
        const deleteButton = document.getElementById('deleteButton');
        const gameDetailsTable = document.getElementById('gameDetailsTable');
        const gameDetailsBody = document.getElementById('gameDetailsBody');
        let selectedGameID = null;
        const reportForm = document.getElementById('reportForm');
        const reportResult = document.getElementById('reportResult');

        reportForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const releaseYear = document.getElementById('releaseYear').value;
            const reportType = document.getElementById('reportType').value;

            if (!releaseYear || !reportType) {
                alert('Please fill in all fields.');
                return;
            }

            try {
                let response;

                if (reportType === 'sum') {
                    response = await fetch('/get-games-sum', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ releaseYear })
                    });
                } else if (reportType === 'avg') {
                    response = await fetch('/get-games-avg', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ releaseYear })
                    });
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch the report');
                }

                const data = await response.json();
                if (reportType === 'sum') {
                    reportResult.textContent = `Total number of games released in ${releaseYear}: ${data.sum}`;
                } else if (reportType === 'avg') {
                    reportResult.textContent = `Average number of games released in ${releaseYear}: ${data.average}`;
                }
            } catch (error) {
                alert('Error fetching report: ' + error.message);
            }
        });

        // Handle form submission for fetching game details
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const gameID = document.getElementById('gameID').value;

            if (!gameID) {
                alert('Please enter a Game ID.');
                return;
            }

            try {
                const response = await fetch('/get-game-details', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ game_ID: gameID })
                });

                if (!response.ok) {
                    throw new Error('Game details not found');
                }

                const gameDetails = await response.json();
                selectedGameID = gameDetails.game_ID;

                gameDetailsTable.style.display = 'block';
                gameDetailsBody.innerHTML = '';

                const row = document.createElement('tr');
                Object.keys(gameDetails).forEach(key => {
                    const cell = document.createElement('td');
                    cell.textContent = gameDetails[key] ?? 'N/A';
                    row.appendChild(cell);
                });
                gameDetailsBody.appendChild(row);
            } catch (error) {
                alert('Error fetching game details: ' + error.message);
            }
        });

        // Handle game update form submission
        updateForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!selectedGameID) {
                alert('Please select a game first.');
                return;
            }

            const updatedData = {
                game_ID: selectedGameID,
                newGameName: document.getElementById('newGameName').value, // Only sending the updated game name
            };

            try {
                const response = await fetch('/update-game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                if (response.ok) {
                    alert('Game updated successfully.');
                    form.dispatchEvent(new Event('submit')); // Fetch updated game details after update
                } else {
                    throw new Error('Failed to update game');
                }
            } catch (error) {
                alert('Error updating game: ' + error.message);
            }
        });


        // Handle game deletion
        deleteButton.addEventListener('click', async function() {
            if (!selectedGameID) {
                alert('Please select a game first.');
                return;
            }

            const confirmDelete = confirm('Are you sure you want to delete this game?');
            if (!confirmDelete) return;

            try {
                const response = await fetch('/delete-game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ game_ID: selectedGameID })
                });

                if (response.ok) {
                    alert('Game deleted successfully.');
                    gameDetailsTable.style.display = 'none';
                    selectedGameID = null;
                } else {
                    throw new Error('Failed to delete game');
                }
            } catch (error) {
                alert('Error deleting game: ' + error.message);
            }
        });
    </script>
</body>
</html>
